rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function estaLogado() { return request.auth != null; }
    function uid() { return request.auth.uid; }

    function eAnonimo() {
      return estaLogado()
        && request.auth.token.firebase != null
        && request.auth.token.firebase.sign_in_provider == "anonymous";
    }

    function refUsuario() {
      return /databases/$(database)/documents/usuarios/$(uid());
    }

    function temDocUsuario() {
      return estaLogado() && exists(refUsuario());
    }

    function dadosUsuario() {
      return temDocUsuario() ? get(refUsuario()).data : null;
    }

    function eAdmin() {
      return temDocUsuario()
        && (dadosUsuario().papel == "admin");
    }

    function escolaDoUsuario() {
      return temDocUsuario() ? dadosUsuario().escolaId : null;
    }

    function validacaoChamadoCriacao(d) {
      return d.escolaId is string
        && d.numeroChamado is int
        && d.codigoChamado is string

        && d.criadoPorUid is string
        && d.criadoPorNome is string
        && d.criadoPorTipo in ["visitante", "admin", "usuario"]
        && (d.criadoPorEmail is string || d.criadoPorEmail == null)

        && d.titulo is string
        && d.descricao is string
        && d.localDoProblema is string

        && d.categoriaId is string
        && (d.prioridade in ["baixa", "normal", "alta", "urgente"] || d.prioridade == null)
        && d.status in ["aberto", "andamento", "resolvido", "prodabel"]

        && (d.responsavelUid is string || d.responsavelUid == null)
        && d.anexos is list;
    }

    // ===== escolas =====
    match /escolas/{escolaId} {
      allow read: if estaLogado();
      allow create, update, delete: if temDocUsuario();

      // configuracoes publicas (o visitante usa para nome/logo do painel)
      match /configuracoes/{docId} {
        allow read: if true;
        allow create, update: if temDocUsuario();
        allow delete: if false;
      }

      // ✅ tokens push dentro de escolas
      match /tokensPush/{tokenId} {
        // Somente admin pode ler/escrever tokens da própria escola
        allow read, create, update, delete: if eAdmin() && escolaId == escolaDoUsuario();
      }
    }

    // ===== usuarios =====
    match /usuarios/{usuarioId} {
      // Necessário para admin verificar papel (você deixou aberto para logados)
      allow read: if estaLogado();

      // Criar próprio perfil de admin
      allow create: if estaLogado()
        && usuarioId == uid()
        && request.resource.data.papel == "admin"
        && request.resource.data.escolaId is string;

      // Atualizar próprio perfil ou admin (temDocUsuario já implica “logado com doc”)
      allow update: if estaLogado() && (usuarioId == uid() || temDocUsuario());

      allow delete: if false;

      match /notificacoes/{notificacaoId} {
        allow read, create, update, delete: if false;
      }

      match /configuracoes/{docId} {
        allow read, create, update: if estaLogado() && usuarioId == uid();
        allow delete: if false;
      }
    }

    // ===== contadores =====
    match /contadores/{escolaId} {
      allow read: if estaLogado();

      allow create, update: if estaLogado()
        && request.resource.data.ultimoNumeroChamado is int
        && (
          !exists(/databases/$(database)/documents/contadores/$(escolaId))
          ||
          (resource.data.ultimoNumeroChamado is int
            && request.resource.data.ultimoNumeroChamado == resource.data.ultimoNumeroChamado + 1)
        );

      allow delete: if false;
    }

    // ===== chamados =====
    match /chamados/{chamadoId} {

      // leitura:
      // - admin (qualquer doc usuario) pode ler
      // - dono do chamado pode ler
      // - anonimo pode ler chamados da escola_padrao (para busca por numero/codigo)
      allow read: if estaLogado() && (
        temDocUsuario()
        || resource.data.criadoPorUid == uid()
        || (eAnonimo() && resource.data.escolaId == "escola_padrao")
      );

      // criação:
      // - visitante/usuario cria na escola_padrao
      // - admin cria (precisa ter doc usuario)
      allow create: if estaLogado()
        && request.resource.data.criadoPorUid == uid()
        && validacaoChamadoCriacao(request.resource.data)
        && (
          (
            request.resource.data.escolaId == "escola_padrao"
            && request.resource.data.criadoPorTipo in ["visitante", "usuario"]
          )
          ||
          (
            temDocUsuario()
            && request.resource.data.criadoPorTipo == "admin"
          )
        );

      // update:
      // - admin atualiza qualquer coisa
      // - dono só pode atualizar campos “seguros” (mantém seus travamentos)
      allow update: if estaLogado() && (
        temDocUsuario()
        ||
        (
          resource.data.criadoPorUid == uid()
          && request.resource.data.escolaId == resource.data.escolaId
          && request.resource.data.numeroChamado == resource.data.numeroChamado
          && request.resource.data.codigoChamado == resource.data.codigoChamado
          && request.resource.data.status == resource.data.status
          && request.resource.data.prioridade == resource.data.prioridade
        )
      );

      allow delete: if temDocUsuario();

      // ===== comentarios =====
      match /comentarios/{comentarioId} {
        allow read: if estaLogado();

        allow create: if estaLogado()
          && request.resource.data.uid == uid()
          && request.resource.data.nome is string
          && request.resource.data.papel in ["admin", "visitante"]
          && request.resource.data.mensagem is string
          && request.resource.data.anexos is list;

        allow update, delete: if temDocUsuario();
      }

      // ===== atualizacoes =====
      match /atualizacoes/{atualizacaoId} {
        allow read: if estaLogado();

        allow create: if temDocUsuario()
          && request.resource.data.tipo in [
            "mudanca_status", "atribuido", "mudanca_prioridade", "mudanca_categoria", "nota"
          ]
          && request.resource.data.texto is string
          && request.resource.data.adminUid == uid()
          && request.resource.data.adminNome is string;

        allow update, delete: if temDocUsuario();
      }
    }

    // ===== paineis =====
    match /paineis/{painelId} {
      allow read: if true;
      allow create, update, delete: if temDocUsuario();
    }
  }
}
